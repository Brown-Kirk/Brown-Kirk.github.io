<html>
  <head>
    <meta content = "text/html; charset = ISO-8859-1" http-equiv = "content-type">
    <script type = "application/javascript">
      /*The AJAX code is adapted from gtjames.github.io . The general structure is his, what I do with it is mine.
      I wanted an example of retrieving a plain text file, but wanted it to do something. So, I put the URL of where I
      want to pull my JSON file from in a txt file, and dropped that on my server. Using the getFileFromServer function,
      I retrieve that file and insert the value (the URL in the file) into the loadJSON function as the source for the data_file
      variable.
      */
      function getFileFromServer(url, divId, isJSON){
        //setting a new instance of XMLHttpRequest
      	var ajaxtextvalue = new XMLHttpRequest();
        //Begin monitoring for a response from the server
        ajaxtextvalue.onreadystatechange = function() {
          //When a the server is ready and sends a response
  				if (ajaxtextvalue.readyState == 4 && ajaxtextvalue.status == 200)
            //Take that response and assign it to the launchURLValue variable
  					var launchURLValue = (isJSON) ? JSON.parse(response) : ajaxtextvalue.responseText;
            //Call the loadJSON function using that variable
            loadJSON(launchURLValue);
  			}
        //Send the get request
      	ajaxtextvalue.open("GET", url, true);
      	ajaxtextvalue.send();
      }
      /*This function retrieves a JSON file from an independent website and displays a list of the next five spacecraft launches
      across the world. It also gives a button by each one that, when selected, will display more details for that launch.
      */
      //Run the loadJSON function with data_file as the sole parameter
      function loadJSON(data_file){
        //Here we are opening up another AJAX request. This one, however, should take browser better into account.
        var http_request = new XMLHttpRequest();
        try{
          http_request = new XMLHttpRequest();
        }
        catch (e){
          try{
            http_request = new ActiveXObject("Msxml2.XMLHTTP");
          }
          catch (e) {
            try{
              http_request = new ActiveXObject("Microsoft.XMLHTTP");
            }
            catch (e){
              alert("Well, crap... That wasn't supposed to happen.");
              return false;
            }
          }
        }
        //Again, watching for the ready state to change so we can receive the JSON file
        http_request.onreadystatechange = function(){
          if (http_request.readyState == 4  ){
            //Parse the JSON file and assign the new object to the jsonObj variable
            var jsonObj = JSON.parse(http_request.responseText);
            //Since we know this JSON is a list of 5 items, go through each one and assign variables based on the values
            for(var i in jsonObj.launches) {
              //Save the number of items in this list as a variable. This is used later to help us remove unused div's
              sessionStorage.setItem("launchcount",i);
              //Get the launch number from the JSON file
              var launchnumber = jsonObj.launches[i].id;
              //Assign an elementID variable that we can use to create a new div
              var launchelementID = "launchchoice" + i;
              //Create a new Div
              var launchElementDivs = document.getElementById(launchelementID);
              //If the div already exists, clear it so we can start from scratch
              if (launchElementDivs != null) {
                launchElementDivs.parentNode.removeChild(launchDetailDiv);
              }
              //Create a new Div
              var detailsDiv = document.getElementById('details');
              //If the div already exists, clear it so we can start from scratch
              if (detailsDiv != null) {
                detailsDiv.parentNode.removeChild(detailsDiv);
              }
              //Create the new URL to retrieve detailed information about the selected launch
              var launchurl = "'https://launchlibrary.net/1.3/launch/" + launchnumber + "'";
              //Create a new Div
              var div = document.createElement('div');
              //Assign an ID to the div
              div.id = launchelementID;
              //Create the content to be displayed in the new div
              div.innerHTML = "Launch: " + launchnumber + " Date: " + jsonObj.launches[i].windowstart + ' <button type = "button" onclick = "loadSecondJSON(' + launchurl + ')">See Details </button> <br><br>';
              //Add what we just created to the div element
              document.body.appendChild(div);
              document.body.appendChild(document.getElementById('explanation'));
              document.getElementById("explanation").className = "thisOne";
            }
          }
        }
        http_request.open("GET", data_file, true);
        http_request.send();
      }
      //This function takes the values from the selected launch and pulls back detailed information about that launch
      //Not commenting for several lines. See similar function above
      function loadSecondJSON(launchurl){
        var data_file = launchurl;
        var http_request = new XMLHttpRequest();
        try{
          http_request = new XMLHttpRequest();
        }
        catch (e){
          try{
            http_request = new ActiveXObject("Msxml2.XMLHTTP");
          }
          catch (e) {
            try{
              http_request = new ActiveXObject("Microsoft.XMLHTTP");
            }
            catch (e){
              alert("Well, crap... That wasn't supposed to happen.");
              return false;
            }
          }
        }
        http_request.onreadystatechange = function(){
          if (http_request.readyState == 4  ){
            //Now we're parsing the new JSON
            var jsonObj2 = JSON.parse(http_request.responseText);
            //Remember that launch count that we saved? Here's where we retrieve it
            var launchcount = sessionStorage.getItem("launchcount");
            //Now we are going to use a do...while loop to remove all those prior elements so we don't have those
            //buttons just sitting around.
            do {
              var launchelementID = "launchchoice" + launchcount;
              var elem = document.getElementById(launchelementID);
              elem.parentNode.removeChild(elem);
              launchcount--;
            }
            while (launchcount >= 0);
            //Here we're pulling individual values from the JSON
            var launchstart = jsonObj2.launches[0].windowstart;
            var launchend = jsonObj2.launches[0].windowend;
            //Combining these two into one statement, just to make it easier to post into the page later
            var launchwindowfull = launchstart + " - " + launchend;
            var launchsite = jsonObj2.launches[0].location.pads[0].name;
            var rocketname = jsonObj2.launches[0].rocket.name;
            var rocketagency = jsonObj2.launches[0].rocket.agencies[0].name;
            var mission = jsonObj2.launches[0].missions[0].name;
            var missiondetails = jsonObj2.launches[0].missions[0].description;
            //Here I wanted to use stringify to turn the object back into a JSON. Then I'll present that on the page as raw data.
            var rawJSON = JSON.stringify(jsonObj2);
            //Creating each paragraph
            var launchWindowDetail = '<h3>Launch Window</h3><p>' + launchwindowfull + '</p>';
            var launchSiteDetail = '<h3>Launch Site</h3><p>' + launchsite + '</p>';
            var rocketNameDetail = '<h3>Rocket Name</h3><p>' + rocketname + '</p>';
            var rocketOwnerDetail = '<h3>Rocket Owner</h3><p>' + rocketagency + '</p>';
            var missionNameDetails = '<h3>Mission Name</h3><p>' + mission + '</p>';
            var missionDescDetails = '<h3>Mission Details</h3><p>' + missiondetails + '</p>';
            var rawJSONvalue = '<h3>Raw JSON Values</h3><p>' + rawJSON + '</p>';
            //Combining all those paragraphs into one div
            var newDivValues = launchWindowDetail + launchSiteDetail + rocketNameDetail + rocketOwnerDetail + missionNameDetails + missionDescDetails + rawJSONvalue;
            var div = document.createElement('div');
            div.id = "details";
            div.innerHTML = newDivValues;
            document.body.appendChild(div);
            document.body.appendChild(document.getElementById("explanation"));
            document.getElementById("explanation").className = "thisOne";
          }
        }
        http_request.open("GET", data_file, true);
        http_request.send();
      }
      function hideExplanation() {
        document.getElementById("explanation").style.display = 'none';
        document.getElementById("hideButton").style.display = 'none';
        document.getElementById("showButton").style.display = 'block';
      }
      function showExplanation() {
        document.getElementById("explanation").style.display = 'block';
        document.getElementById("hideButton").style.display = 'block';
        document.getElementById("showButton").style.display = 'none';
        document.body.appendChild(document.getElementById('explanation'));
        document.getElementById("explanation").className = "thisOne";
        changeFontColor();
      }
      function changeFontColor() {
        var classToChange = document.getElementsByClassName('thisOne');
        for(i=0; i<classToChange.length; i++) {
          classToChange[i].style.color = 'blue';
        }
      }

    </script>
    <title>JSON Demonstration</title>
  </head>
  <body onload="hideExplanation()">
    <h1>JSON retrieval</h1>
    <p>This page retrieves information from https://launchlibrary.net . In order to view details regarding how this page displays knowledge of required CIT261 criteria,
    click the "Show Explanation" button. To hide this explanation, click the "Hide Explanation" </p>
    <button id = "hideButton" type = "button" onclick = "hideExplanation()">Hide Explanation</button>
    <button id = "showButton" type = "button" onclick = "showExplanation()">Show Explanation</button>
    <div id = "central">
      <h3>AJAX</h3>
      <p>The primary function of this page is to retrieve a JSON file from an external site, in this case, launchlibrary.net. It does this using the AJAX request shown
        below. This function takes the URL or location of the file as a parameter. </p>
      <code>function loadJSON(data_file){
              var http_request = new XMLHttpRequest();
              try{
                http_request = new XMLHttpRequest();
              }
              catch (e){
                try{
                  http_request = new ActiveXObject("Msxml2.XMLHTTP");
                }
                catch (e) {
                  try{
                    http_request = new ActiveXObject("Microsoft.XMLHTTP");
                  }
                  catch (e){
                    alert("Well, crap... That wasn't supposed to happen.");
                    return false;
                  }
                }
              }
              http_request.onreadystatechange = function(){
                if (http_request.readyState == 4  ){
                  var jsonObj = JSON.parse(http_request.responseText);
                  for(var i in jsonObj.launches) {
                    sessionStorage.setItem("launchcount",i);
                    var launchnumber = jsonObj.launches[i].id;
                    var launchelementID = "launchchoice" + i;
                    var launchElementDivs = document.getElementById(launchelementID);
                    if (launchElementDivs != null) {
                      launchElementDivs.parentNode.removeChild(launchDetailDiv);
                    }
                    var detailsDiv = document.getElementById('details');
                    if (detailsDiv != null) {
                      detailsDiv.parentNode.removeChild(detailsDiv);
                    }
                    var launchurl = "'https://launchlibrary.net/1.3/launch/" + launchnumber + "'";
                    var div = document.createElement('div');
                    div.id = launchelementID;
                    div.innerHTML = "Launch: " + launchnumber + " Date: " + jsonObj.launches[i].windowstart + ' <button type = "button" onclick = "loadSecondJSON(' + launchurl + ')">See Details </button> <br><br>';
                    document.body.appendChild(div);
                    document.body.appendChild(document.getElementById('explanation'));
                    document.getElementById("explanation").className = "thisOne";
                  }
                }
              }</code>
      <h3>JSON</h3>
      <p>Once we have received the JSON through the above code, we parse it using the JSON.parse function. From here, we toss it into a for each, processing each of the five primary objects contained in the JSON.
        Later on, we use the stringify option to get it back into JSON format so that we can display to the user the raw JSON data.</p>
      <code>var jsonObj = JSON.parse(http_request.responseText);</code>
      <h3>Local Storage</h3>
      <p>Although I hope to add additional storage options, I am currently using the sessionStorage  command to save the number of launches we have pulled data for. This is then retrieved later, again using the
        sessionStorage command, in order to remove the DIV’s for each launch and then display the details for just the chosen item. I’d be happy to show how to save and retrieve other types of objects, but they
        would all be very similar to this. I did choose to only save using sessionStorage, and not using localStorage, so that the data would be specific to this browser session.</p>
      <h3>DOM</h3>
      <p>This is used quite a bit throughout the entire script. I use document.getElementById quite a bit to identify specific DIV’s, sometimes following that up with <div name>.parentNode.removeChild to remove
        an existing DIV. I utilize document.createElement to create new DIV’s, innerHTML to create content within the DIV, document.body.appendChild to place the DIV. There are other examples throughout the
        script. I also use the “appendChild” at times in order to get my explanation to always be at the bottom of the page. </p>
      <h3>CSS Class Manipulation</h3>
      <p>I interpreted this requirement in two ways – one, changing the class name of an object using JavaScript or , two, changing the properties of an object. So, I’ve done both in this script. I only have one
        example of changing the class name, as it only made sense in one area of my script. I use the code:
      <code>document.getElementById("explanation").className = "thisOne";</code>
      to change the class of the “explanation” div to “thisOne”. However, I have several examples of changing other properties. In order to show and hide this explanation, I use the .style.display = “none” or = “block” property. I use this in two separate functions – one to hide the explanation, one to show it. I also show how you can use JavaScript to change all of the elements with a certain class. Using the changeFontColor function, I cycle through every element with the class name of “thisOne” and change the font color to blue. </p>
      <button type = "button" onclick = "getFileFromServer( '/ajaxtextfile.txt', 'Textdiv', false )">Update Details </button>
    </div>
    <div id = "explanation">
      <h3>CIT261 Explanation</h3>
      <p>This is the text I want to hide and then display</p>
    </div>
</body>
</html>
